<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Afordness — QR Generator (Quiet Zone + Logo)</title>

<!-- qrcode-generator 라이브러리 (large data safe) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>

<style>
  :root{
    --bg:#07102a; --card:#071427; --accent:#facc15; --muted:#9aa4ff;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter,Segoe UI,system-ui,Arial;
    background:linear-gradient(180deg,#020617,#000);
    color:#e6eefc;
    padding:20px;
    display:flex;
    justify-content:center;
  }

  .wrap{width:100%;max-width:1100px;display:grid;grid-template-columns:420px 1fr;gap:18px}
  .card{background:rgba(255,255,255,0.02);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  h2{margin:0 0 8px 0;color:var(--accent)}
  label{font-size:13px;color:var(--muted);display:block;margin-top:10px}
  textarea,input,select,button{width:100%;padding:10px;border-radius:8px;border:none;background:#071632;color:#fff;margin-top:8px}
  textarea{height:120px;resize:vertical}
  .row{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:#9aa4ff;margin-top:6px}
  .preview{display:flex;align-items:center;justify-content:center;min-height:420px}
  .canvas-wrap{background:#fff;padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
  .controls-inline{display:flex;gap:8px}
  input[type="range"]{width:100%}
  .meta{font-size:13px;color:#9aa4ff;margin-top:8px}
  .note{font-size:12px;color:#ffd580;margin-top:8px}
  a.link{color:#7cc0ff;word-break:break-all}
  @media(max-width:900px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>

<div class="wrap">

  <!-- LEFT: Controls -->
  <div class="card">
    <h2>Afordness — QR (Quiet zone + Logo)</h2>
    <div class="small">Type text (or paste), choose size & logo — QR will have equal white border on all sides.</div>

    <label>QR Content (text or public URL)</label>
    <textarea id="text" placeholder="Write receipt / message / or paste the public viewer URL..."></textarea>

    <label>QR Pixel Size (final image width/height)</label>
    <select id="size">
      <option value="320">320 px</option>
      <option value="420" selected>420 px</option>
      <option value="520">520 px</option>
    </select>

    <label>Quiet zone (white border) — pixels</label>
    <input id="quiet" type="number" min="8" max="120" value="20" />

    <label>Upload Logo (optional)</label>
    <input type="file" id="logo" accept="image/*">

    <label>Logo size (%)</label>
    <input id="logosize" type="range" min="8" max="30" value="18" />
    <div class="meta">Logo = <span id="logosizeLabel">18</span>% of QR</div>

    <label>QR Color</label>
    <input type="color" id="color" value="#000000">

    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn" onclick="generate()" style="flex:1;padding:12px;border-radius:8px;background:linear-gradient(90deg,#facc15,#e6b800);color:#07102a;font-weight:700">Generate QR</button>
      <button onclick="download()" style="flex:1;padding:12px;border-radius:8px;background:#12223f;color:#fff;border:none">Download PNG</button>
    </div>

    <label style="margin-top:12px">Public link (if you want to check)</label>
    <input id="publicLink" readonly placeholder="Generated public link (if used)">

    <div class="note">Tip: For perfect square quiet-zone keep pixel >= 12. Logo recommended &lt;= 20% for safe scanning.</div>
  </div>

  <!-- RIGHT: Preview -->
  <div class="card preview" id="previewCard">
    <div id="previewInner" style="width:100%;display:flex;flex-direction:column;align-items:center;gap:12px">
      <div class="canvas-wrap" id="canvasWrap" style="min-width:160px;min-height:160px">
        <div style="color:#6b7280">No QR yet — generate to preview</div>
      </div>
      <div id="linkArea" style="width:100%"></div>
    </div>
  </div>

</div>

<script>
/* state */
const textEl = document.getElementById('text');
const sizeEl = document.getElementById('size');
const quietEl = document.getElementById('quiet');
const colorEl = document.getElementById('color');
const logoInput = document.getElementById('logo');
const logosizeEl = document.getElementById('logosize');
const logosizeLabel = document.getElementById('logosizeLabel');
const previewWrap = document.getElementById('canvasWrap');
const publicLinkEl = document.getElementById('publicLink');

let logoImg = null;

/* logo loader */
logoInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f){ logoImg = null; return; }
  const url = URL.createObjectURL(f);
  const img = new Image();
  img.onload = ()=> { logoImg = img; URL.revokeObjectURL(url); };
  img.onerror = ()=> { alert('Logo load failed, try other image'); logoImg = null; };
  img.src = url;
});

/* logo size label */
logosizeEl.addEventListener('input', ()=>{
  logosizeLabel.textContent = logosizeEl.value;
});

/* generate function with exact quiet zone on all sides */
function generate(){
  const raw = textEl.value.trim();
  if(!raw){ alert('Please enter text or URL first'); return; }

  // read options
  const finalPx = parseInt(sizeEl.value,10) || 420;
  let quietPx = parseInt(quietEl.value,10);
  if(isNaN(quietPx) || quietPx < 0) quietPx = 20;
  const color = colorEl.value || '#000000';
  const logoPercent = Math.max(8, Math.min(30, parseInt(logosizeEl.value,10))) / 100;

  // build QR using qrcode-generator
  const qr = qrcode(0,'H');
  qr.addData(raw);
  qr.make();

  const modules = qr.getModuleCount();

  // compute scale so that modules*scale + 2*quietPx ~= finalPx
  // choose scale = floor((finalPx - 2*quietPx) / modules)
  const available = Math.max(1, finalPx - 2*quietPx);
  let scale = Math.floor(available / modules);
  if(scale < 1) scale = 1; // fallback
  const qrSize = modules * scale;
  const canvasSize = qrSize + 2 * quietPx;

  // create canvas
  const canvas = document.createElement('canvas');
  canvas.width = canvas.height = canvasSize;
  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingEnabled = false;

  // fill white background (quiet zone area included)
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,canvasSize,canvasSize);

  // draw QR at offset = quietPx
  for(let r=0;r<modules;r++){
    for(let c=0;c<modules;c++){
      ctx.fillStyle = qr.isDark(r,c) ? color : "#ffffff";
      ctx.fillRect(quietPx + c*scale, quietPx + r*scale, scale, scale);
    }
  }

  // draw logo if exists (centered) with white rounded pad
  if(logoImg){
    // compute logo size relative to qrSize (not including quiet zone)
    const logoSize = Math.max(8, Math.round(qrSize * logoPercent));
    const x = Math.round((canvasSize - logoSize) / 2);
    const y = Math.round((canvasSize - logoSize) / 2);

    // draw white rounded rectangle pad for safety
    const pad = Math.max(6, Math.round(logoSize * 0.14));
    roundRect(ctx, x - pad, y - pad, logoSize + pad*2, logoSize + pad*2, 10);
    ctx.fillStyle = "#ffffff";
    ctx.fill();

    // draw logo image
    try {
      ctx.drawImage(logoImg, x, y, logoSize, logoSize);
    } catch(e){
      console.error('drawImage failed', e);
    }
  }

  // show in preview area (replace)
  previewWrap.innerHTML = '';
  previewWrap.appendChild(canvas);

  // also show a clickable raw string (if it's a URL show link)
  const linkArea = document.getElementById('linkArea');
  linkArea.innerHTML = '';
  const maybeUrl = isLikelyURL(raw);
  if(maybeUrl){
    linkArea.innerHTML = `<div style="width:100%;text-align:center;margin-top:8px"><a class="link" href="${escapeHtml(raw)}" target="_blank">${escapeHtml(raw)}</a></div>`;
    publicLinkEl.value = raw;
  } else {
    publicLinkEl.value = '';
  }

  // store final for download
  canvas.dataset.generated = '1';
}

/* download */
function download(){
  const canvas = previewWrap.querySelector('canvas');
  if(!canvas || !canvas.dataset.generated){
    alert('Generate QR first');
    return;
  }
  const name = (document.getElementById('filename') && document.getElementById('filename').value) || 'afordness_qr';
  const a = document.createElement('a');
  a.href = canvas.toDataURL('image/png');
  a.download = name + '.png';
  a.click();
}

/* helpers */
function roundRect(ctx, x, y, w, h, r){
  if (w < 2*r) r = w/2;
  if (h < 2*r) r = h/2;
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
}

function isLikelyURL(s){
  if(!s) return false;
  return /^https?:\/\//i.test(s);
}
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

</script>
</body>
  </html>
